<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.132.0">
    <meta name="description" content="">
<meta name="author" content="kiennt.sg@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Creating a Single-Master Cluster with Kubeadm :: Never stop trying</title>

    
    <link href="/css/nucleus.css?1723707792" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1723707792" rel="stylesheet">
    <link href="/css/hybrid.css?1723707792" rel="stylesheet">
    <link href="/css/featherlight.min.css?1723707792" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1723707792" rel="stylesheet">
    <link href="/css/auto-complete.css?1723707792" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1723707792" rel="stylesheet">
    <link href="/css/theme.css?1723707792" rel="stylesheet">
    <link href="/css/hugo-theme.css?1723707792" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1723707792" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1723707792"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/3-handsonlabs/3.1-createk8s/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1723707792"></script>
<script type="text/javascript" src="/js/auto-complete.js?1723707792"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1723707792"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-introduce/" title="Giới thiệu" class="dd-item 
        
        
        
        ">
      <a href="/1-introduce/">
           <b> 1. </b> Giới thiệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prerequiste/" title="Các bước chuẩn bị" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/">
           <b> 2. </b> Các bước chuẩn bị
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createvpc/" title="Chuẩn bị VPC và Security Group" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createvpc/">
           <b> 2.1 </b> Chuẩn bị VPC và Security Group
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-createcfn/" title="Tạo Stack Cloudformation" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-createcfn/">
           <b> 2.2 </b> Tạo Stack Cloudformation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-handsonlabs/" title="Hands on Labs " class="dd-item 
        parent
        
        
        ">
      <a href="/3-handsonlabs/">
           <b> 3. </b> Hands on Labs 
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3-handsonlabs/3.1-createk8s/" title="Creating a Single-Master Cluster with Kubeadm" class="dd-item 
        
        active
        
        ">
      <a href="/3-handsonlabs/3.1-createk8s/">
           <b> 3.1. </b> Creating a Single-Master Cluster with Kubeadm
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-handsonlabs/3.2-upgradecluster/" title="Upgrading a Single-Master Cluster Version with Kubeadm" class="dd-item 
        
        
        
        ">
      <a href="/3-handsonlabs/3.2-upgradecluster/">
           <b> 3.2. </b> Upgrading a Single-Master Cluster Version with Kubeadm
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-handsonlabs/3.3-backuprestoreetcd/" title="Backing Up and Restoring etcd" class="dd-item 
        
        
        
        ">
      <a href="/3-handsonlabs/3.3-backuprestoreetcd/">
           <b> 3.3. </b> Backing Up and Restoring etcd
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-handsonlabs/3.4-rbacuser/" title="Regulating Access to API Resources with RBAC" class="dd-item 
        
        
        
        ">
      <a href="/3-handsonlabs/3.4-rbacuser/">
           <b> 3.4. </b> Regulating Access to API Resources with RBAC
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-cleanup/" title="Dọn dẹp tài nguyên  " class="dd-item 
        
        
        
        ">
      <a href="/4-cleanup/">
          <b>6. </b>Dọn dẹp tài nguyên  
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
   
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>22-08-2024</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="ihcloudvn.com"  style="color:orange">Kiên Nguyễn  </a> <br>
                <a href="chatgpt.com"  style="color:orange">ChatGPT </a> <br>
                <a href="google.com"  style="color:orange">Google </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Kubernetes on AWS</a> > <a href='/3-handsonlabs/'>Hands on Labs </a> > Creating a Single-Master Cluster with Kubeadm
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Creating a Single-Master Cluster with Kubeadm
            </h1>
          

        



	<p>Chào mừng các bạn đến bài lab triển khai K8s trên EC2 AWS dùng kubeadm.</p>
<p>Trong bài lab này mình sẽ hướng dẫn các bạn triển khai cụm K8s.</p>
<p><strong>Mục tiêu</strong>:</p>
<ul>
<li>Hiểu được cách triển khai K8s dùng kubeadm trên EC2 AWS</li>
<li>Xử lý lỗi nếu có</li>
</ul>
<p><strong>Thiết lập môi trường</strong></p>
<p>Một số thông số yêu cầu trước khi cài đặt</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Version</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>UBUNTU SERVER</td>
<td>22.04.3</td>
<td><a href="https://ubuntu.com/download/server">https://ubuntu.com/download/server</a></td>
</tr>
<tr>
<td>KUBERNETES</td>
<td>1.29.1</td>
<td><a href="https://kubernetes.io/releases/">https://kubernetes.io/releases/</a></td>
</tr>
<tr>
<td>CONTAINERD</td>
<td>1.7.13</td>
<td><a href="https://containerd.io/releases/">https://containerd.io/releases/</a></td>
</tr>
<tr>
<td>RUNC</td>
<td>1.1.12</td>
<td><a href="https://github.com/opencontainers/runc/releases">https://github.com/opencontainers/runc/releases</a></td>
</tr>
<tr>
<td>CNI PLUGINS</td>
<td>1.4.0</td>
<td><a href="https://github.com/containernetworking/plugins/releases">https://github.com/containernetworking/plugins/releases</a></td>
</tr>
<tr>
<td>CALICO CNI</td>
<td>3.27.2</td>
<td><a href="https://docs.tigera.io/calico/3.27/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/3.27/getting-started/kubernetes/quickstart</a></td>
</tr>
</tbody>
</table>
<p>Trong bài Lab này mình sử dụng 4 EC2:</p>
<table>
<thead>
<tr>
<th>EC2</th>
<th>Qty</th>
<th>AMI</th>
<th>vCPU</th>
<th>Memory</th>
</tr>
</thead>
<tbody>
<tr>
<td>ec2-cluster</td>
<td>1</td>
<td>Ubuntu 22.04</td>
<td>1</td>
<td>1GB</td>
</tr>
<tr>
<td>ec2-control-plane</td>
<td>1</td>
<td>Ubuntu 22.04</td>
<td>2</td>
<td>4GB</td>
</tr>
<tr>
<td>ec2-worker1</td>
<td>2</td>
<td>Ubuntu 22.04</td>
<td>1</td>
<td>1GB</td>
</tr>
</tbody>
</table>
<p><strong>Các bạn truy cập vào link bên dưới, để dùng Cloudformation thiết lập môi trường nhé:</strong></p>
<ul>
<li><a href="https://ap-southeast-1.console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/create?stackName=lab1&templateURL=https://workshopk8scfnstoragres.s3.ap-southeast-1.amazonaws.com/HOL21_Workshop.yaml">VPC Cloudformation Stack</a></li>
</ul>
<p>Link sẽ tự động chuyển hướng về Cloudformation Console, các bạn thay đổi một số thông tin trước khi deploy:</p>
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stack name</td>
<td>[yourname]-lab1</td>
</tr>
<tr>
<td>EC2KeyPairName</td>
<td>Select Keypair EC2</td>
</tr>
<tr>
<td><strong>MemberHOL</strong></td>
<td><strong>your_name</strong></td>
</tr>
</tbody>
</table>

<div class="notices info" ><p>Lưu ý: Các bạn phải chọn đúng tên mình không được chọn thay tên người khác!!!.</p>
</div>

<p><img alt="Cfn" src="/images/006.png"></p>
<p><img alt="Cfn" src="/images/007.png"></p>
<p><img alt="Cfn" src="/images/008.png"></p>
<p>Các bạn click <strong>Next</strong></p>
<p><img alt="Cfn" src="/images/009.png"></p>
<p>Sau khi đã kiểm tra kỹ càng các bạn click &ldquo;Submit&rdquo; để hệ thống tiến hành triển khai</p>
<p><img alt="Cfn" src="/images/010.png"></p>
<p>Các bạn đợi một vài phút để triển khai các tài nguyên cần thiết cho việc triển khai.</p>
<p><img alt="Cfn" src="/images/011.png"></p>
<p>Sau khi Cloudformation đã chạy xong, chúng ta vào EC2 Console, lúc này sẽ có 4 EC2 đang <strong>Running</strong></p>
<p><img alt="Cfn" src="/images/012.png"></p>
<p>Chúng ta tiến hành remote vào từng EC2 để cấu hình:</p>
<p>Có 2 cách để remote:</p>
<ol>
<li>Các bạn có thể remote trực tiếp trên trình duyệt.</li>
<li>Các bạn có thể sử dụng một số công cụ terminal để login với keypair đã khai báo trước đó.</li>
</ol>
<p>Ở đây mình sẽ sử dụng remote bằng trình duyệt web.</p>
<p><img alt="Cfn" src="/images/013.png"></p>
<p><img alt="Cfn" src="/images/014.png"></p>
<h4 id="cấu-hình-control-plane-node"><strong>Cấu hình Control-plane node</strong></h4>
<p>Các bạn login vào EC2 Control-plane Node</p>
<p>Chuyển sang mode root</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo su
</span></span></code></pre></div><p><img alt="Cfn" src="/images/015.png"></p>
<p>Trong quá trình triển khai Cloudformation đã giúp chúng ta cài đặt một số thư viện có sẵn bạn có thể tham khảo script bên dưới</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span>apt install unzip -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34;</span> -o <span style="color:#e6db74">&#34;awscliv2.zip&#34;</span>
</span></span><span style="display:flex;"><span>unzip awscliv2.zip
</span></span><span style="display:flex;"><span>sudo ./aws/install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load required kernel modules</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/modules-load.d/containerd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>modprobe overlay
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Setup required sysctl params</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install containerd</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containerd/containerd/releases/download/v1.7.13/containerd-1.7.13-linux-amd64.tar.gz -P /tmp/
</span></span><span style="display:flex;"><span>tar -C /usr/local -xzf /tmp/containerd-1.7.13-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -P /etc/systemd/system/
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install runc</span>
</span></span><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64 -P /tmp/
</span></span><span style="display:flex;"><span>install -m <span style="color:#ae81ff">755</span> /tmp/runc.amd64 /usr/local/sbin/runc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install CNI plugins</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz -P /tmp/
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>tar -C /opt/cni/bin -xzf /tmp/cni-plugins-linux-amd64-v1.4.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure containerd</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default | tee /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/SystemdCgroup = false/SystemdCgroup = true/&#39;</span> /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Disable swap</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install dependencies</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y apt-transport-https ca-certificates curl gpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add Kubernetes apt repository</span>
</span></span><span style="display:flex;"><span>mkdir -p -m <span style="color:#ae81ff">755</span> /etc/apt/keyrings
</span></span><span style="display:flex;"><span>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /&#39;</span> | tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update apt and install Kubernetes components</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y kubelet<span style="color:#f92672">=</span>1.29.1-1.1 kubeadm<span style="color:#f92672">=</span>1.29.1-1.1 kubectl<span style="color:#f92672">=</span>1.29.1-1.1
</span></span><span style="display:flex;"><span>apt-mark hold kubelet kubeadm kubectl
</span></span></code></pre></div><p>Bây giờ chúng ta sẽ tiến hành khởi chạy Kubernetes bằng lệnh như sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Initialize the Kubernetes control plane</span>
</span></span><span style="display:flex;"><span>kubeadm init --pod-network-cidr 192.168.0.0/16 --kubernetes-version 1.29.1
</span></span></code></pre></div><p><img alt="Cfn" src="/images/016.png"></p>
<p>Sau khi init không lỗi nó sẽ thông báo successfully</p>
<p><img alt="Cfn" src="/images/017.png"></p>
<p><strong>Output</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>  sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Alternatively, <span style="color:#66d9ef">if</span> you are the root user, you can run:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You should now deploy a pod network to the cluster.
</span></span><span style="display:flex;"><span>Run <span style="color:#e6db74">&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style="display:flex;"><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubeadm join 10.0.1.168:6443 --token bip3vm.s1h46hf1lczg623k <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --discovery-token-ca-cert-hash sha256:432ae9d8d1f9174c0ffea6c3f015036b1b27e5f32506c4825daa147657a8ca5a 
</span></span></code></pre></div><p>Hiện tại Kubernetes đang run với root user, nếu chúng ta muốn thêm user để có thể sử dụng truy vấn đến Kubernetes thì ta thực hiện một số câu lệnh bên dưới:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Add kube config to ubuntu user.</span>
</span></span><span style="display:flex;"><span>mkdir -p /home/ubuntu/.kube;
</span></span><span style="display:flex;"><span>cp -i /etc/kubernetes/admin.conf /home/ubuntu/.kube/config;
</span></span><span style="display:flex;"><span>chmod <span style="color:#ae81ff">755</span> /home/ubuntu/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set up kubeconfig for the root user</span>
</span></span><span style="display:flex;"><span>export KUBECONFIG<span style="color:#f92672">=</span>/etc/kubernetes/admin.conf
</span></span></code></pre></div>
<div class="notices info" ><p>Lưu ý hiện tại user chạy với full quyền admin K8s, để giới hạn một số role ta sẽ thực hiện ở bài Lab 3.4</p>
</div>

<p><img alt="Cfn" src="/images/018.png"></p>
<p>Tiếp theo chúng ta sẽ cài đặt Calico CNI cho K8s</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Install Calico CNI</span>
</span></span><span style="display:flex;"><span>kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/tigera-operator.yaml
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/custom-resources.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f custom-resources.yaml
</span></span></code></pre></div><p><img alt="Cfn" src="/images/019.png"></p>
<p>Kiểm tra kết quả sau khi cài đặt</p>
<p><img alt="Cfn" src="/images/020.png"></p>
<p>Ta dùng lệnh:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get node
</span></span></code></pre></div><p><img alt="Cfn" src="/images/021.png"></p>
<p>Ta thấy hiện tại chỉ có một control-plane node đã join vào cụm K8s, lúc này ta sẽ join các Worker node vào cụm K8s sau bằng lênh:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Generate kubeadm join command and save to a file</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span></code></pre></div><p><img alt="Cfn" src="/images/022.png"></p>
<p>Kết quả hiển thị 1 dòng lệnh, lúc này ta login vào các Worker Node để tiến hành cấu hình Join vào cụm K8s trên</p>
<p><strong>Output</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 10.0.1.168:6443 --token s34g2r.rgpyp5ksuoyh29r9 --discovery-token-ca-cert-hash sha256:432ae9d8d1f9174c0ffea6c3f015036b1b27e5f32506c4825daa147657a8ca5a
</span></span></code></pre></div><h4 id="cấu-hình-các-worker-node"><strong>Cấu hình các Worker node</strong></h4>
<p>Các bạn login vào EC2 Workers Node 1</p>
<p>Chuyển sang mode root</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo su
</span></span></code></pre></div><p><img alt="Cfn" src="/images/023.png"></p>
<p>Trong quá trình triển khai Cloudformation đã giúp chúng ta cài đặt một số thư viện có sẵn bạn có thể tham khảo script bên dưới:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>apt update
</span></span><span style="display:flex;"><span>apt install unzip -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34;</span> -o <span style="color:#e6db74">&#34;awscliv2.zip&#34;</span>
</span></span><span style="display:flex;"><span>unzip awscliv2.zip
</span></span><span style="display:flex;"><span>sudo ./aws/install
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load required kernel modules</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/modules-load.d/containerd.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>modprobe overlay
</span></span><span style="display:flex;"><span>modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Setup required sysctl params</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt;EOF | tee /etc/sysctl.d/99-kubernetes-cri.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.ipv4.ip_forward = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install containerd</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containerd/containerd/releases/download/v1.7.13/containerd-1.7.13-linux-amd64.tar.gz -P /tmp/
</span></span><span style="display:flex;"><span>tar -C /usr/local -xzf /tmp/containerd-1.7.13-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service -P /etc/systemd/system/
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install runc</span>
</span></span><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64 -P /tmp/
</span></span><span style="display:flex;"><span>install -m <span style="color:#ae81ff">755</span> /tmp/runc.amd64 /usr/local/sbin/runc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install CNI plugins</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz -P /tmp/
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>tar -C /opt/cni/bin -xzf /tmp/cni-plugins-linux-amd64-v1.4.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configure containerd</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default | tee /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/SystemdCgroup = false/SystemdCgroup = true/&#39;</span> /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Disable swap</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Install dependencies</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y apt-transport-https ca-certificates curl gpg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add Kubernetes apt repository</span>
</span></span><span style="display:flex;"><span>mkdir -p -m <span style="color:#ae81ff">755</span> /etc/apt/keyrings
</span></span><span style="display:flex;"><span>curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /&#39;</span> | tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Update apt and install Kubernetes components</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y kubelet<span style="color:#f92672">=</span>1.29.1-1.1 kubeadm<span style="color:#f92672">=</span>1.29.1-1.1 kubectl<span style="color:#f92672">=</span>1.29.1-1.1
</span></span><span style="display:flex;"><span>apt-mark hold kubelet kubeadm kubectl
</span></span></code></pre></div><p>Chúng ta tiến hành join cụm Worker node vào K8s ở trên bạn lênh:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join 10.0.1.168:6443 --token s34g2r.rgpyp5ksuoyh29r9 --discovery-token-ca-cert-hash sha256:432ae9d8d1f9174c0ffea6c3f015036b1b27e5f32506c4825daa147657a8ca5a
</span></span></code></pre></div>
<div class="notices note" ><p>Lệnh này được sinh ra từ Control-plane mà ta đã chạy trước đó</p>
</div>

<p><img alt="Cfn" src="/images/024.png"></p>
<p>Chúng login lại control plane node và tiến hành kiểm tra xem worker node đã join vào cụm K8s chưa</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get node
</span></span></code></pre></div><p><img alt="Cfn" src="/images/025.png"></p>
<p>Ta thấy Worker 1 đã join vào cụm K8s</p>

<div class="notices note" ><p>Các bạn làm tương tự cho Worker 2 Node nhé</p>
</div>

<p>Kết quả đạt được</p>
<p><img alt="Cfn" src="/images/026.png"></p>
<p>Như vậy bạn qua bài Lab trên đã giúp bạn cài đặt K8s sử dụng kubeadm.</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/3-handsonlabs/" title="Hands on Labs "> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/3-handsonlabs/3.2-upgradecluster/" title="Upgrading a Single-Master Cluster Version with Kubeadm" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1723707792"></script>
    <script src="/js/perfect-scrollbar.min.js?1723707792"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1723707792"></script>
    <script src="/js/jquery.sticky.js?1723707792"></script>
    <script src="/js/featherlight.min.js?1723707792"></script>
    <script src="/js/highlight.pack.js?1723707792"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1723707792"></script>
    <script src="/js/learn.js?1723707792"></script>
    <script src="/js/hugo-learn.js?1723707792"></script>

    <link href="/mermaid/mermaid.css?1723707792" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1723707792"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
